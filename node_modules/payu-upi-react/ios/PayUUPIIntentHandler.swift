//
//  PayUUPICollectHandler.swift
//  payu-tpv
//
//  Created by Rajvinder Singh on 25/07/21.
//
import PayUParamsKit
import PayUUPICoreKit

class PayUUPIIntentHandler: NSObject {
    var handler = PayUUPIHybridIntentHandler()
    func initiatePayment(paramDict: NSDictionary,
                         errorCallback: @escaping RCTResponseSenderBlock) {
        
        DispatchQueue.main.async { [weak self] in
            guard let rootVC = RCTPresentedViewController() else {
                PayUUPICore.shared.paymentCompletion?(.failure(.unknownError()))
                return
            }
            let validatedParams = self?.handler.validatePaymentParam(paramDict: paramDict)
            if let paymentParam = validatedParams?.paymentParam, let intentApp = validatedParams?.intentApp {
                self?.handler.initiateIntentPayment(withApp: intentApp, paymentParams: paymentParam, fromVC: rootVC)
            } else {
                errorCallback([validatedParams?.error ?? [:]])
            }
        }
    }
    
    func intentApps(with successCallback: @escaping RCTResponseSenderBlock) {
        DispatchQueue.main.async { [weak self] in
            let installedApps = self?.handler.getIntentApps()
            successCallback([installedApps ?? []])
        }
    }
    
}
